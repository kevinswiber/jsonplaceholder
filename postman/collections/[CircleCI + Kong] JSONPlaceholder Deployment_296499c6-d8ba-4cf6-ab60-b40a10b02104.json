{
    "info": {
        "_postman_id": "b66f14c7-b43e-4e16-9ca6-f550f059799f",
        "name": "[CircleCI + Kong] Deployment",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "item": [
        {
            "name": "Initialize",
            "item": [
                {
                    "name": "Get OpenAPI Definition",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "id": "6d471495-bdea-4ddc-9920-bdd7e8758b29",
                                "exec": [
                                    "pm.test('status code is 200', () => {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "const response = pm.response.json();",
                                    "",
                                    "pm.test('response has schema', () => {",
                                    "  pm.expect(response.schema.schema).to.exist;",
                                    "});",
                                    "",
                                    "pm.collectionVariables.set('openapi', JSON.stringify(response.schema.schema));"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "id": "7f603fc9-1775-481a-abab-338148732639",
                    "protocolProfileBehavior": {
                        "disableBodyPruning": true
                    },
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "X-API-Key",
                                "value": "{{postmanAPIKey}}",
                                "type": "text"
                            }
                        ],
                        "url": {
                            "raw": "https://api.getpostman.com/apis/{{apiId}}/versions/{{apiVersionId}}/schemas/{{schemaId}}",
                            "protocol": "https",
                            "host": [
                                "api",
                                "getpostman",
                                "com"
                            ],
                            "path": [
                                "apis",
                                "{{apiId}}",
                                "versions",
                                "{{apiVersionId}}",
                                "schemas",
                                "{{schemaId}}"
                            ]
                        }
                    },
                    "response": []
                }
            ],
            "id": "e5bbb7e7-4f97-4d8d-b3ef-96c8c68ebeac",
            "event": [
                {
                    "listen": "prerequest",
                    "script": {
                        "id": "cbe8c176-da7d-40a7-ad8b-6a3e3677c198",
                        "type": "text/javascript",
                        "exec": [
                            "const requiredVariables = [",
                            "  'kubeBaseUrl',",
                            "  'o2kBaseUrl',",
                            "  'apiId',",
                            "  'apiVersionId',",
                            "  'schemaId',",
                            "  'postmanAPIKey'",
                            "];",
                            "",
                            "const missingVars = requiredVariables.filter((item) => {",
                            "  const v = pm.variables.get(item);",
                            "  return !v || v[0] === '<';",
                            "});",
                            "",
                            "if (missingVars.length) {",
                            "  const message = [",
                            "    `The following variables are required: ${missingVars.join(', ')}.`,",
                            "    'They can be set under the Variables tab of the Collection.'",
                            "  ].join(' ');",
                            "",
                            "  throw new Error(message);",
                            "}",
                            "",
                            "const resetVars = [",
                            "  'openapi',",
                            "  'kongKubernetesResources',",
                            "  'index',",
                            "  'resourcePathCache'",
                            "]",
                            "",
                            "for (const item of resetVars) {",
                            "  pm.collectionVariables.set(item, '');",
                            "}"
                        ]
                    }
                },
                {
                    "listen": "test",
                    "script": {
                        "id": "b1f058f5-d1d8-4ab8-a29e-1917583f4869",
                        "type": "text/javascript",
                        "exec": [
                            ""
                        ]
                    }
                }
            ]
        },
        {
            "name": "Run",
            "item": [
                {
                    "name": "OpenAPI to Kong",
                    "item": [
                        {
                            "name": "Convert OpenAPI to Kong Config",
                            "event": [
                                {
                                    "listen": "prerequest",
                                    "script": {
                                        "id": "b5bcdb62-c5a1-40ee-bba7-b83a8a200be6",
                                        "exec": [
                                            "const openapi = pm.variables.get('openapi');",
                                            "",
                                            "if (openapi) {",
                                            "  pm.variables.set('openapi', JSON.parse(openapi));",
                                            "}"
                                        ],
                                        "type": "text/javascript"
                                    }
                                },
                                {
                                    "listen": "test",
                                    "script": {
                                        "id": "77b47414-a5b2-43ce-a3e4-756ad38091a7",
                                        "exec": [
                                            "pm.test('status code is 200', () => {",
                                            "  pm.response.to.have.status(200);",
                                            "});",
                                            "",
                                            "const response = pm.response.json();",
                                            "",
                                            "pm.test('response has length', () => {",
                                            "  pm.expect(response.length).to.be.gt(0);",
                                            "});",
                                            "",
                                            "pm.test('response is JSON', () => {",
                                            "  pm.expect(pm.response.headers.get('Content-Type')).to.match(/^application\\/json/);",
                                            "});",
                                            "",
                                            "pm.collectionVariables.set('kongKubernetesResources', JSON.stringify(response));"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "id": "d498be89-5265-4a1b-8a1d-7c4022cbfc5b",
                            "protocolProfileBehavior": {
                                "disableBodyPruning": true
                            },
                            "request": {
                                "method": "POST",
                                "header": [
                                    {
                                        "key": "Content-Type",
                                        "value": "text/yaml",
                                        "type": "text"
                                    }
                                ],
                                "body": {
                                    "mode": "raw",
                                    "raw": "{{openapi}}",
                                    "options": {
                                        "raw": {
                                            "language": "text"
                                        }
                                    }
                                },
                                "url": {
                                    "raw": "{{o2kBaseUrl}}/converter",
                                    "host": [
                                        "{{o2kBaseUrl}}"
                                    ],
                                    "path": [
                                        "converter"
                                    ]
                                }
                            },
                            "response": []
                        }
                    ],
                    "id": "58207477-43ca-45a3-b3eb-4d9e8faccf73",
                    "event": [
                        {
                            "listen": "prerequest",
                            "script": {
                                "id": "3bb383cc-be7b-44fc-b7c3-b4c5f446ebce",
                                "type": "text/javascript",
                                "exec": [
                                    "if (!pm.variables.get('openapi')) {",
                                    "  const message = [",
                                    "    `The following variable is required: openapi.`,",
                                    "    'It can be set under the Variables tab of the Collection',",
                                    "    'or by running the \"Initialize/Get Open API Definition\" request.'",
                                    "  ].join(' ');",
                                    "  ",
                                    "  throw new Error(message);",
                                    "}"
                                ]
                            }
                        },
                        {
                            "listen": "test",
                            "script": {
                                "id": "9177c44d-64b7-494d-8fd1-b9ea310107d9",
                                "type": "text/javascript",
                                "exec": [
                                    ""
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "Kubernetes",
                    "item": [
                        {
                            "name": "Find Resource Paths",
                            "event": [
                                {
                                    "listen": "prerequest",
                                    "script": {
                                        "id": "5853ccdd-067e-479d-839e-5fabf3749bbe",
                                        "exec": [
                                            ""
                                        ],
                                        "type": "text/javascript"
                                    }
                                },
                                {
                                    "listen": "test",
                                    "script": {
                                        "id": "11e9bbfa-4c40-4b88-a17c-45553e4c83df",
                                        "exec": [
                                            "pm.test('status code is 200', () => {",
                                            "  // Make sure Kubernetes API Server is accessible.",
                                            "  pm.response.to.have.status(200);",
                                            "});",
                                            "",
                                            "const resourcesVar = pm.variables.get('kongKubernetesResources');",
                                            "",
                                            "if (!resourcesVar) {",
                                            "  throw new Error([",
                                            "    'The following variable is required: resources.',",
                                            "    'Run the \"OpenAPI to Kong/Convert OpenAPI to Kong Config\" request',",
                                            "    'to populate the variable.'",
                                            "  ].join(' '));",
                                            "}",
                                            "",
                                            "const resources = JSON.parse(resourcesVar);",
                                            "",
                                            "const savedCache = pm.variables.get('resourcePathCache');",
                                            "resourcePathCache = savedCache ? JSON.parse(savedCache) : {};",
                                            "",
                                            "const _dummy = setTimeout(() => {",
                                            "  clearTimeout(_dummy);",
                                            "  throw new Error('Tests timed out. Consider modifying timeout duration.');",
                                            "}, 30000);",
                                            "",
                                            "const sendRequest = (req) => {",
                                            "    return new Promise((resolve, reject) => {",
                                            "        pm.sendRequest(req, (err, res) => {",
                                            "            if (err) {",
                                            "                return reject(err);",
                                            "            }",
                                            "",
                                            "            return resolve(res);",
                                            "        })",
                                            "    });",
                                            "};",
                                            "",
                                            "const kubeBaseUrl = pm.variables.get('kubeBaseUrl');",
                                            "",
                                            "(async function main() {",
                                            "  for (let resource of resources) {",
                                            "    const pathIdentifier = `${resource.apiVersion}/${resource.kind}`;",
                                            "    if (!resourcePathCache[pathIdentifier]) {",
                                            "      const groupRequest = {",
                                            "        url: `${kubeBaseUrl}/apis/${resource.apiVersion}`,",
                                            "        method: 'GET',",
                                            "      };",
                                            "",
                                            "      const groupResponse = await sendRequest(groupRequest);",
                                            "      const group = groupResponse.json();",
                                            "",
                                            "      const resourceRepresentation = group.resources.find((item) => {",
                                            "        return item.kind === resource.kind; ",
                                            "      });",
                                            "      if (!resourceRepresentation) {",
                                            "        throw new Error(`Resource ${resource.kind} isn't available on your Kubernetes API Server.`)",
                                            "      }",
                                            "",
                                            "      let resourcePath = `apis/${resource.apiVersion}`;",
                                            "      if (resourceRepresentation.namespaced) {",
                                            "        const namespace = pm.variables.get('kubeNamespace') || 'default';",
                                            "        resourcePath += `/namespaces/${namespace}`;",
                                            "      }",
                                            "      resourcePath += `/${resourceRepresentation.name}`;",
                                            "",
                                            "      resourcePathCache[pathIdentifier] = resourcePath;",
                                            "    }",
                                            "  }",
                                            "",
                                            "  pm.collectionVariables.set('resourcePathCache', JSON.stringify(resourcePathCache));",
                                            "",
                                            "  clearTimeout(_dummy);",
                                            "})();",
                                            ""
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "id": "35e83b19-29e3-4de1-bd95-6bbc8a560529",
                            "protocolProfileBehavior": {
                                "disableBodyPruning": true
                            },
                            "request": {
                                "method": "GET",
                                "header": [],
                                "url": {
                                    "raw": "{{kubeBaseUrl}}/apis",
                                    "host": [
                                        "{{kubeBaseUrl}}"
                                    ],
                                    "path": [
                                        "apis"
                                    ]
                                }
                            },
                            "response": []
                        },
                        {
                            "name": "Create or Update Kubernetes Resource",
                            "event": [
                                {
                                    "listen": "prerequest",
                                    "script": {
                                        "id": "3085f0d6-eb03-4ac1-abcf-21e9d00688b5",
                                        "exec": [
                                            "new Function(pm.variables.get('jsonMergePatch'))();",
                                            "",
                                            "let indexVar = pm.variables.get('index');",
                                            "",
                                            "if (!indexVar) {",
                                            "  pm.collectionVariables.set('index', '0');",
                                            "  indexVar = '0';",
                                            "}",
                                            "",
                                            "const index = Number(indexVar);",
                                            "const resources = JSON.parse(pm.variables.get('kongKubernetesResources'));",
                                            "",
                                            "if (index >= resources.length) {",
                                            "  throw new Error(\"Index is greater than the number of Kubernetes resources.  Consider resetting it to 0 in the collection variables.\")",
                                            "}",
                                            "",
                                            "const savedCache = pm.variables.get('resourcePathCache');",
                                            "if (!savedCache) {",
                                            "  throw new Error([",
                                            "    'The variable resourcePathCache has not been set.',",
                                            "    'Please run \"Kubernetes/Find Resource Paths\" to populate this variable.'",
                                            "  ].join(' '));",
                                            "}",
                                            "",
                                            "resourcePathCache = JSON.parse(savedCache);",
                                            "",
                                            "let resource = resources[index];",
                                            "const pathIdentifier = `${resource.apiVersion}/${resource.kind}`;",
                                            "let resourcePath = resourcePathCache[pathIdentifier];",
                                            "",
                                            "const _dummy = setTimeout(() => {",
                                            "  clearTimeout(_dummy);",
                                            "  throw new Error('Tests timed out. Consider modifying timeout duration.');",
                                            "}, 30000);",
                                            "",
                                            "const sendRequest = (req) => {",
                                            "    return new Promise((resolve, reject) => {",
                                            "        pm.sendRequest(req, (err, res) => {",
                                            "            if (err) {",
                                            "                return reject(err);",
                                            "            }",
                                            "",
                                            "            return resolve(res);",
                                            "        })",
                                            "    });",
                                            "};",
                                            "",
                                            "(async function main() {",
                                            "  const kubeBaseUrl = pm.variables.get('kubeBaseUrl');",
                                            "  const itemsResponse = await sendRequest(`${kubeBaseUrl}/${resourcePath}`);",
                                            "  const items = itemsResponse.json().items;",
                                            "",
                                            "  const found = items.find((item) => {",
                                            "    return item.metadata.name === resource.metadata.name;",
                                            "  });",
                                            "",
                                            "  if (found) {",
                                            "    pm.variables.set('M', 'PATCH');",
                                            "    resourcePath += `/${resource.metadata.name}`",
                                            "    resource = jsonmergepatch.apply(resource, found);",
                                            "    pm.request.addHeader('Content-Type: application/merge-patch+json');",
                                            "  } else {",
                                            "    pm.variables.set('M', 'POST');",
                                            "  }",
                                            "",
                                            "  pm.variables.set('resourcePath', resourcePath);",
                                            "  pm.variables.set('resourceBody', JSON.stringify(resource));",
                                            "",
                                            "  clearTimeout(_dummy);",
                                            "})();"
                                        ],
                                        "type": "text/javascript"
                                    }
                                },
                                {
                                    "listen": "test",
                                    "script": {
                                        "id": "d003a34c-3113-4afd-bd00-07596c7f1a4a",
                                        "exec": [
                                            "if (pm.request.method === 'POST') {",
                                            "  pm.test('status code is 201', () => {",
                                            "    pm.response.to.have.status(201);",
                                            "  });",
                                            "} else if (pm.request.method === 'PATCH') {",
                                            "  pm.test('status code is 200', () => {",
                                            "    pm.response.to.have.status(200);",
                                            "  }); ",
                                            "}",
                                            "",
                                            "const index = Number(pm.variables.get('index'));",
                                            "const resources = JSON.parse(pm.variables.get('kongKubernetesResources'));",
                                            "",
                                            "if (index === resources.length - 1) {",
                                            "  postman.setNextRequest(null);",
                                            "  pm.collectionVariables.set('index', '0');",
                                            "} else {",
                                            "  pm.collectionVariables.set('index', String(index+1));",
                                            "  postman.setNextRequest('Create or Update Kubernetes Resource');",
                                            "}"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "id": "7bccf4b2-8812-42ad-8ae4-b9177d398d45",
                            "protocolProfileBehavior": {
                                "disableBodyPruning": true
                            },
                            "request": {
                                "method": "{{M}}",
                                "header": [],
                                "body": {
                                    "mode": "raw",
                                    "raw": "{{resourceBody}}",
                                    "options": {
                                        "raw": {
                                            "language": "json"
                                        }
                                    }
                                },
                                "url": {
                                    "raw": "{{kubeBaseUrl}}/{{resourcePath}}",
                                    "host": [
                                        "{{kubeBaseUrl}}"
                                    ],
                                    "path": [
                                        "{{resourcePath}}"
                                    ]
                                }
                            },
                            "response": []
                        }
                    ],
                    "id": "793b6226-c025-4b71-ab37-2ceac5a0829d",
                    "event": [
                        {
                            "listen": "prerequest",
                            "script": {
                                "id": "233b3dca-bd0d-4f5c-9327-b5390d174f0b",
                                "type": "text/javascript",
                                "exec": [
                                    "const token = pm.variables.get('token');",
                                    "if (token) {",
                                    "  pm.request.addHeader(`Authorization: Bearer ${token}`);",
                                    "}"
                                ]
                            }
                        },
                        {
                            "listen": "test",
                            "script": {
                                "id": "8fd3b281-b9a9-4c30-98d1-0fac00219876",
                                "type": "text/javascript",
                                "exec": [
                                    ""
                                ]
                            }
                        }
                    ]
                }
            ],
            "id": "ee319657-77d7-45e4-98fd-f23b377cd16f"
        }
    ],
    "event": [
        {
            "listen": "prerequest",
            "script": {
                "id": "8593b07d-dad4-4294-b5e5-d86441109473",
                "type": "text/javascript",
                "exec": [
                    ""
                ]
            }
        },
        {
            "listen": "test",
            "script": {
                "id": "f66f1fc2-ead5-455a-a0a4-3fc0ceb9ed41",
                "type": "text/javascript",
                "exec": [
                    ""
                ]
            }
        }
    ],
    "variable": [
        {
            "id": "71b2f019-0002-4889-abef-43067f568195",
            "key": "kubeBaseUrl",
            "value": "https://kubernetes.default.svc"
        },
        {
            "id": "be20ff3d-c45e-437a-bce1-7b2244f353d0",
            "key": "kubeNamespace",
            "value": "default"
        },
        {
            "id": "63a7a075-fed2-447c-b62a-986b3bac062d",
            "key": "o2kBaseUrl",
            "value": "http://localhost:3001"
        },
        {
            "id": "9528a126-e8d2-4435-b1a3-f4d11cfffad2",
            "key": "apiId",
            "value": "<<Only needed in Postman app, not Newman>>"
        },
        {
            "id": "56922b40-f3e5-4093-87dc-b21c0e33911a",
            "key": "apiVersionId",
            "value": "<<Only needed in Postman app, not Newman>>"
        },
        {
            "id": "fe713abb-cbae-4604-a31e-2e6508c5a086",
            "key": "schemaId",
            "value": "<<Only needed in Postman app, not Newman>>"
        },
        {
            "id": "baa054c9-da7d-4054-9e31-f17166d72f65",
            "key": "postmanAPIKey",
            "value": "<<Only needed in Postman app, not Newman>>"
        },
        {
            "id": "7c5efdb3-34c6-4d0c-9ad6-9b1b408884e6",
            "key": "openapi",
            "value": "<<Set automatically in Postman app>> "
        },
        {
            "id": "f2d52adc-59d4-4b54-87b2-8746045c8a31",
            "key": "kongKubernetesResources",
            "value": "<<Set automatically>>"
        },
        {
            "id": "045dc374-d0da-4b30-8a48-541f511d10f3",
            "key": "index",
            "value": "<<Set automatically>>"
        },
        {
            "id": "d593dfc3-9800-4b5e-97ae-12ac411cddf8",
            "key": "resourcePathCache",
            "value": "<<Set automatically>>"
        },
        {
            "id": "8fae35de-17f4-477f-8e59-ed2d2537cdfc",
            "key": "jsonMergePatch",
            "value": "(()=>{var r={10:(r,e,t)=>{\"use strict\";r.exports.apply=t(774),r.exports.generate=t(811),r.exports.merge=t(302)},774:(r,e,t)=>{\"use strict\";var o=t(988).q;r.exports=function r(e,t){if(null===(t=o(t))||\"object\"!=typeof t||Array.isArray(t))return t;(null===(e=o(e))||\"object\"!=typeof e||Array.isArray(e))&&(e={});for(var n=Object.keys(t),u=0;u<n.length;u++){var f=n[u];if(\"__proto__\"===f||\"constructor\"===f||\"prototype\"===f)return e;null===t[f]?e.hasOwnProperty(f)&&delete e[f]:e[f]=r(e[f],t[f])}return e}},811:(r,e,t)=>{\"use strict\";var o=t(63),n=t(988).q;r.exports=function r(e,t){if(e=n(e),t=n(t),null===e||null===t||\"object\"!=typeof e||\"object\"!=typeof t||Array.isArray(e)!==Array.isArray(t))return t;if(Array.isArray(e))return function(r,e){if(r.length!==e.length)return!1;for(var t=0;t<r.length;t++)if(!o(e[t],r[t]))return!1;return!0}(e,t)?void 0:t;var u,f,i={},s=Object.keys(e),c=Object.keys(t),a={};for(f=0;f<c.length;f++)u=c[f],-1===s.indexOf(u)&&(a[u]=!0,i[u]=n(t[u]));var l={};for(f=0;f<s.length;f++)if(u=s[f],-1===c.indexOf(u))l[u]=!0,i[u]=null;else if(null!==e[u]&&\"object\"==typeof e[u]){var y=r(e[u],t[u]);void 0!==y&&(i[u]=y)}else e[u]!==t[u]&&(i[u]=n(t[u]));return Object.keys(i).length>0?i:void 0}},302:r=>{\"use strict\";r.exports=function r(e,t){if(null===e||null===t||\"object\"!=typeof e||\"object\"!=typeof t||Array.isArray(e)!==Array.isArray(t))return t;var o=JSON.parse(JSON.stringify(e));return Object.keys(t).forEach((function(n){void 0!==e[n]?o[n]=r(e[n],t[n]):o[n]=t[n]})),o}},988:r=>{\"use strict\";r.exports.q=function(r){return r&&\"function\"==typeof r.toJSON?r.toJSON():r}},63:r=>{\"use strict\";r.exports=function r(e,t){if(e===t)return!0;if(e&&t&&\"object\"==typeof e&&\"object\"==typeof t){if(e.constructor!==t.constructor)return!1;var o,n,u;if(Array.isArray(e)){if((o=e.length)!=t.length)return!1;for(n=o;0!=n--;)if(!r(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if((o=(u=Object.keys(e)).length)!==Object.keys(t).length)return!1;for(n=o;0!=n--;)if(!Object.prototype.hasOwnProperty.call(t,u[n]))return!1;for(n=o;0!=n--;){var f=u[n];if(!r(e[f],t[f]))return!1}return!0}return e!=e&&t!=t}}},e={},t=function t(o){var n=e[o];if(void 0!==n)return n.exports;var u=e[o]={exports:{}};return r[o](u,u.exports,t),u.exports}(10),o=jsonmergepatch=\"undefined\"==typeof jsonmergepatch?{}:jsonmergepatch;for(var n in t)o[n]=t[n];t.__esModule&&Object.defineProperty(o,\"__esModule\",{value:!0})})();"
        }
    ]
}